<div class="tab-pane" id="personnalBike">
  <!-- TAB2: RÉSERVER UN VELO -->
  <?php
  /** @TODO: REPLACE BY API CALL **/
  $sql = "select aa.EMAIL, aa.FRAME_NUMBER, aa.NOM, aa.PRENOM, aa.PHONE, aa.ADRESS, aa.POSTAL_CODE, aa.CITY, aa.WORK_ADRESS, aa.WORK_POSTAL_CODE, aa.WORK_CITY, bb.CONTRACT_START, bb.CONTRACT_END, dd.BRAND, dd.MODEL, dd.FRAME_TYPE
  from customer_referential aa, customer_bikes bb, customer_bike_access cc, bike_catalog dd
  where aa.EMAIL='" . $user_data['EMAIL'] . "' and aa.EMAIL=cc.EMAIL and cc.BIKE_ID=bb.ID and bb.TYPE=dd.ID and cc.TYPE='personnel'";
  if ($conn->query($sql) === FALSE)
    die;
  $row = mysqli_fetch_assoc(mysqli_query($conn, $sql));
  $contractNumber = 'KAMEO BIKES'; //@TODO: Remove var
  $contractStart = $row['CONTRACT_START'];
  $contractEnd = $row['CONTRACT_END'];
  ?>
  <?php /**   TRAVEL INFORMATIONS @TODO: NEED REFACTORISATION TO REMOVE BAD DEFINED RESPONSIVITY AND LOAD DATA DYNAMICALLY **/ ?>

  <img class="img-responsive img-rounded center" id='personnalBikeImg' alt="Image of Bike">
  <br />
  <!-- BIKE DESCRIPTION -->
  <div class="table-responsive">
    <table class="table table-striped" id="personnalBikeDataTable">
      <h4 class="text-green"> <?= L::bike_description_title; ?> </h4>
      <tbody>
        <tr>
          <td><?= L::bike_description_model; ?></td>
          <td class="brandModelPersonnalBike"></td>
        </tr>
        <tr>
          <td><?= L::bike_description_contract_start; ?></td>
          <td class="contractStartPersonnalBike"></td>
        </tr>
        <tr>
          <td><?= L::bike_description_contract_end; ?></td>
          <td class="contractEndPersonnalbike"></td>
        </tr>
      </tbody>
    </table>
    <a data-target="#calculRachatVeloPersonalTab" class='calculRachatVeloPersonalTabLink' class="text-green" data-toggle="modal" href="#">informations rachat du vélo</a><br><br>
  </div>
  <hr>

  <h4 class="text-green"> Actions prises sur le vélo</h4>
  <table class="table table-striped" id="personnalBikeActionTable" style="width:100%" >
  </table>

</div>


<script type="text/javascript">
  function load_personnal_bike(){
    $.ajax({
      url: "apis/Kameo/get_bike_details.php",
      type: "get",
      success: function (response) {
        if (response.response == "error") {
          console.log(response.message);
        } else {
          $('.brandModelPersonnalBike').html(response.brand+" "+response.modelCatalog);
          $('.contractStartPersonnalBike').html(response.contractStart);
          $('.contractEndPersonnalbike').html(response.contractEnd);
          $('.calculRachatVeloPersonalTabLink').attr("leasingPrice", response.leasingPrice);
          $('.calculRachatVeloPersonalTabLink').attr("catalogprice", response.catalogPrice);
          $('.calculRachatVeloPersonalTabLink').attr("catalogprice", response.catalogPrice);
          $('#personnalBikeImg').attr('src', "images_bikes/"+response.img+".jpg");

        }
      }
    });


    $.ajax({
       url: "apis/Kameo/action_bike_management.php",
       type: "post",
       data: {
         "readActionBike-action": "read",
       },
       success : function(data) {
         $('#personnalBikeActionTable').dataTable( {
         destroy: true,
         responsive: true,
         bInfo : false,
         paging: false,
         searching: false,
         data : data.action,
         columns: [
         {
            title: "Date",
            data: "date",
            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
              $(nTd).html(sData.substring(0, 10));
            },
          },
          {
             title: "Description",
             data: "title",
             fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
               if (sData == 'maintenance') $(nTd).html("Entretien fait");
               else if(sData == 'maintenance')$(nTd).html(description);
             },
           }
         ],
         order: [
           [0, "desc"]
         ]
        });
       }
     });



  }
  load_personnal_bike();

  $( ".calculRachatVeloPersonalTabLink" ).click(function() {
    $('#valeurRachatTablePesonnalTab').html("");
    var parent = document.createElement("tr");
    var cell = document.createElement("th");
    cell.innerHTML="Mois";
    parent.append(cell);
    var cell = document.createElement("th");
    cell.innerHTML="Valeur de Rachat (TVAC)";
    parent.append(cell);
    $('#valeurRachatTablePesonnalTab').append(parent);


    var leasingprice=this.getAttribute('leasingPrice');
    var catalogPrice=this.getAttribute('catalogprice');
    for(i=12; i<37; i++){
      var parent = document.createElement("tr");
      var cell = document.createElement("td");
      if(i==12){
        cell.innerHTML="Mois [1-12]";
      }else{
        cell.innerHTML="Mois "+i;
      }
      parent.append(cell);
      var cell = document.createElement("td");
      if(i==12){
        cell.innerHTML=Math.round(catalogPrice*1.21)+" €";
      }else{
        cell.innerHTML=Math.round((0.6*(36-i)*leasingprice*1.21 + 0.16*catalogPrice)*1.21)+" €";
      }
      parent.append(cell);
      $('#valeurRachatTablePesonnalTab').append(parent);
    }
  })

</script>
